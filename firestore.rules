rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Quizzes: Public read, validated writes, allow admin deletes
    match /quizzes/{quizId} {
      allow read: if true;
      allow write: if isValidQuiz();
      allow delete: if true;
    }
    
    // Quiz Results: Public read, validated creates, admin can delete ALL
    match /quizResults/{resultId} {
      allow read: if true;
      allow create: if isValidResult();
      allow update: if false; // Prevent score tampering
      allow delete: if isAdminUser(); // FIXED: Allow admin to delete for leaderboard reset
    }
    
    // Admin operations - allow full access for authenticated admin users
    match /{document=**} {
      allow read, write, delete: if isAdminUser();
    }
    
    // FUNCTIONS
    function isValidQuiz() {
      return request.resource.data.title is string &&
             request.resource.data.title.size() > 0 &&
             request.resource.data.questions is list &&
             request.resource.data.questions.size() > 0;
    }
    
    function isValidResult() {
      return request.resource.data.userName is string &&
             request.resource.data.userName.size() <= 50 &&
             request.resource.data.score is number &&
             request.resource.data.percentage >= 0 &&
             request.resource.data.percentage <= 100;
    }
    
    // ADMIN AUTHENTICATION - Add your admin email here
    function isAdminUser() {
      return request.auth != null && 
             request.auth.token.email == 'khansifi7867860@gmail.com'; // REPLACE WITH YOUR EMAIL
    }
    
    // Alternative: Allow deletion from any authenticated user (less secure but simpler)
    // function isAdminUser() {
    //   return request.auth != null;
    // }
  }
}
