rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Quizzes: Public read, validated writes, allow admin deletes
    match /quizzes/{quizId} {
      allow read: if true;
      allow write: if isValidQuiz();
      allow delete: if true; // Allow any authenticated user to delete
    }
    
    // Quiz Results: Public read, validated creates, FIXED - allow authenticated users to delete
    match /quizResults/{resultId} {
      allow read: if true;
      allow create: if isValidResult();
      allow update: if false; // Prevent score tampering
      allow delete: if request.auth != null; // FIXED: Any authenticated user can delete
    }
    
    // FUNCTIONS
    function isValidQuiz() {
      return request.resource.data.title is string &&
             request.resource.data.title.size() > 0 &&
             request.resource.data.questions is list &&
             request.resource.data.questions.size() > 0;
    }
    
    function isValidResult() {
      return request.resource.data.userName is string &&
             request.resource.data.userName.size() <= 50 &&
             request.resource.data.score is number &&
             request.resource.data.percentage >= 0 &&
             request.resource.data.percentage <= 100;
    }
  }
}
